import{r as n,u as Q,j as t,w as Y}from"./chunk-JMJ3UQ3L-CakUOnqu.js";import{c as Z,j as G,i as k,C as T,B as C,X as z,S as ee}from"./CommonDialog-EJvDp-ao.js";import{u as W,I as $,a as te,P as re}from"./useStoredImage-D6dM61ux.js";import{p as V,r as ne,s as se,u as F,B as le}from"./BgmControl-CBFU0q6t.js";const ae=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],oe=Z("loader-circle",ae),X=(e={})=>{const r=n.useRef(null),s=n.useRef(null),d=n.useRef(null),l=n.useRef(()=>{}),a=n.useRef(!0),b=n.useRef(1),h=n.useRef(!1);n.useEffect(()=>{d.current=e.onDrumrollEnd??null},[e.onDrumrollEnd]);const m=n.useCallback(()=>{const o=a.current?b.current:0;r.current&&r.current.volume(o),s.current&&s.current.volume(o)},[]);n.useEffect(()=>{a.current=e.enabled??!0,m()},[m,e.enabled]),n.useEffect(()=>{b.current=e.volume??1,m()},[m,e.volume]);const y=n.useCallback(()=>{const o=s.current;o&&(!a.current||b.current<=0||(o.stop(),o.seek(0),o.play()))},[]);n.useEffect(()=>{l.current=()=>{h.current&&(h.current=!1,d.current?.(),y())}},[y]),n.useEffect(()=>{const o=new G.Howl({src:["/drumroll.mp3"],preload:!0,onend:()=>l.current(),onloaderror:()=>l.current(),onplayerror:()=>l.current()}),v=new G.Howl({src:["/cymbal.mp3"],preload:!0});return r.current=o,s.current=v,m(),()=>{o.unload(),v.unload(),r.current=null,s.current=null}},[m]);const S=n.useCallback(()=>{const o=r.current;o&&(!a.current||b.current<=0||(h.current=!0,o.stop(),o.seek(0),o.play()))},[]),w=n.useCallback(()=>{const o=r.current;o&&(h.current=!1,o.stop())},[]);return{playDrumroll:S,stopDrumroll:w,playCymbal:y}},ce=e=>[...e.drawHistory].sort((r,s)=>s.sequence-r.sequence),J=1,ue=75,ie=ue-J+1;class q extends Error{constructor(){super("no-available-numbers"),this.name="NoAvailableNumbersError"}}const de=()=>Array.from({length:ie},(e,r)=>J+r),K=e=>{const r=new Set(e.map(s=>s.number));return de().filter(s=>!r.has(s))},me=(e,r)=>{if(e.length===0)throw new q;if(typeof r=="number"&&Number.isFinite(r)){const l=Math.abs(Math.trunc(r))%e.length;return e[l]}const s=Math.min(e.length-1,Math.floor(Math.random()*e.length));return e[s]},fe=(e,r={})=>{const s=K(e.drawHistory);if(s.length===0)throw new q;const d=r.timestamp??new Date().toISOString(),l=me(s,r.seed),a={number:l,sequence:e.drawHistory.length+1,drawnAt:d};return{...e,currentNumber:l,drawHistory:[...e.drawHistory,a],isDrawing:!1,updatedAt:d}},xe=Array.from({length:75},(e,r)=>r+1),U=async()=>{const e=await ne();return e||se()},H=async e=>{const r=ce(e.gameState),s=K(e.gameState.drawHistory);return{...e,historyView:r,availableNumbers:s}},he=()=>{const[e,r]=n.useState(null),[s,d]=n.useState(!0),[l,a]=n.useState(!1),[b,h]=n.useState(!1),[m,y]=n.useState(null),[S,w]=n.useState(null),[o,v]=n.useState(!1),I=Q(),[j,E]=n.useState(null),[f,c]=n.useState(!1),g=n.useRef(null),N=n.useRef(!1),i=e?.availableNumbers??[],p=l||b||f||i.length===0,x=e?.gameState.currentNumber??null;n.useEffect(()=>{let u=!0;return(async()=>{try{const D=await U(),A=await H(D);if(!u)return;r(A),y(null)}catch(D){if(!u)return;y(D instanceof Error?D.message:"load-session-error")}finally{u&&d(!1)}})(),()=>{u=!1}},[]),n.useEffect(()=>{f||E(x)},[f,x]),n.useEffect(()=>()=>{g.current&&clearInterval(g.current)},[]);const R=async()=>{a(!0);try{const u=e??await U(),M=fe(u.gameState),D={...u,gameState:M};await V(D);const A=await H(D);r(A),w(null)}catch(u){if(u instanceof q){w("no-available-numbers");return}w("draw-error")}finally{a(!1)}},B=async()=>{if(e){h(!0);try{const u=new Date().toISOString(),M={...e.gameState,currentNumber:null,drawHistory:[],isDrawing:!1,updatedAt:u},D={...e,gameState:M};await V(D);const A=await H(D);r(A),w(null),v(!1)}finally{h(!1)}}},P=()=>{if(f||l||b||i.length===0)return;const u=i.length>0?i:xe;c(!0),N.current=!0,g.current=setInterval(()=>{const M=u[Math.floor(Math.random()*u.length)];E(M)},120)},O=()=>{N.current&&(N.current=!1,g.current&&(clearInterval(g.current),g.current=null),c(!1),R())},L=()=>{I("/start")},_=i.length===0?"抽選は完了しました":f||l?"抽選中":"抽選を開始！";return{session:e,isLoading:s,isMutating:l,isResetting:b,loadError:m,drawError:S,resetOpen:o,displayNumber:j,isAnimating:f,availableNumbers:i,isButtonDisabled:p,drawButtonLabel:_,openResetDialog:()=>v(!0),closeResetDialog:()=>v(!1),startDrawAnimation:P,completeDrawAnimation:O,handleReset:B,handleBackToStart:L}},ge=({value:e,isDrawing:r})=>{const s=e==null?"--":e.toString();return t.jsx("div",{className:"flex flex-col items-center gap-6 text-foreground",children:t.jsx("div",{className:k("flex h-112 w-md items-center justify-center rounded border border-border bg-card font-bold text-[15rem] transition",r?"opacity-50":"opacity-100"),children:s})})},be=({recent:e,className:r=""})=>t.jsx("section",{className:k("flex h-full flex-col rounded-3xl border border-border bg-card p-4 text-foreground",r),children:t.jsx("div",{className:k("no-scrollbar flex-1 overflow-y-auto pr-2",e.length===0?"flex h-full w-full items-center justify-center":""),children:e.length===0?t.jsx("div",{className:"text-muted-foreground text-sm",children:"まだ抽選結果されてないよ"}):t.jsx("div",{className:"grid grid-cols-3 gap-4",children:e.map(s=>t.jsx("div",{className:"flex aspect-square min-h-30 items-center justify-center rounded border border-border text-6xl",children:s.number},s.sequence))})})}),pe=({open:e,title:r="抽選履歴を削除する？",description:s="あたらしく抽選を始めよう！",onClose:d,onConfirm:l,disabled:a=!1})=>t.jsx(T,{open:e,onClose:d,title:r,description:s,showCloseButton:!0,closeDisabled:a,footer:t.jsxs(t.Fragment,{children:[t.jsx(C,{type:"button",variant:"outline",className:"flex-1 rounded-2xl border border-border px-4 py-3 text-muted-foreground hover:bg-muted",onClick:d,disabled:a,children:"キャンセル"}),t.jsx(C,{type:"button",className:"flex-1 rounded-2xl border border-transparent bg-destructive px-4 py-3 text-destructive-foreground hover:bg-destructive/90",onClick:l,disabled:a,children:"削除"})]})}),ye=({prize:e,disabled:r=!1,onToggle:s,showPrizeNameOnly:d,onToggleDisplay:l})=>{const a=W(e.imagePath),b=!!a,h=()=>{s(e.id,!e.selected)};return t.jsxs("li",{className:k("flex items-center gap-3 rounded-2xl border px-3 py-3 text-sm transition",e.selected?"border-border bg-muted opacity-70":"border-border bg-card"),children:[t.jsx("div",{className:"flex aspect-4/3 w-14 items-center justify-center overflow-hidden rounded-lg bg-muted",children:b?t.jsx("img",{src:a??"",alt:`${e.prizeName||"景品"} 画像`,className:"h-full w-full object-cover object-center"}):t.jsx($,{className:"h-8 w-8 text-muted-foreground",strokeWidth:1.5,"aria-hidden":"true"})}),t.jsx("div",{className:"flex-1",children:t.jsx("button",{type:"button",className:k("w-full cursor-pointer text-left text-3xl focus:outline-none",e.selected?"text-muted-foreground line-through":"text-foreground"),onClick:()=>l(e.id),disabled:r,children:d?e.prizeName:e.itemName})}),t.jsx(C,{type:"button",variant:(e.selected,"secondary"),className:k("rounded-full px-4 py-1 text-xs",e.selected&&"border border-border text-muted-foreground"),onClick:h,disabled:r,children:e.selected?"戻す":"除外"})]})},Ne=({prizes:e,disabled:r=!1,onToggle:s,itemNameOverrides:d,onToggleDisplay:l})=>e.length===0?t.jsx("p",{className:"text-muted-foreground text-sm",children:"まだ景品が登録されてないよ"}):t.jsx("ul",{className:"h-full w-full space-y-3",children:e.map(a=>t.jsx(ye,{prize:a,disabled:r,onToggle:s,showPrizeNameOnly:!d.has(a.id),onToggleDisplay:l},a.id))}),we=({open:e,prize:r,onClose:s})=>{const d=W(r?.imagePath??null),l=!!d;return r?t.jsx(T,{open:e,onClose:s,title:"おめでとうございます！",titleClassName:"pt-8 text-3xl",headerClassName:"text-center",contentClassName:"flex flex-col items-center justify-center",showCloseButton:!0,children:t.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[t.jsx("div",{className:"flex h-48 w-full items-center justify-center rounded-2xl",children:l?t.jsx("img",{src:d??"",alt:`${r.prizeName||"景品"} 画像`,className:"h-full w-full rounded-2xl object-cover object-center"}):t.jsx($,{className:"h-48 w-48 text-muted-foreground",strokeWidth:1.5,"aria-hidden":"true"})}),t.jsxs("div",{className:"flex w-full flex-col items-center justify-center space-y-2 text-3xl text-foreground",children:[t.jsx("p",{children:r.prizeName||"未設定"}),t.jsx("p",{children:r.itemName||"未設定"})]})]})}):null},ve=({open:e,prizes:r,onClose:s,onComplete:d})=>{const[l,a]=n.useState(0),[b,h]=n.useState(null),m=n.useRef(null),y=n.useRef([]),S=n.useRef([]),w=n.useRef(()=>{}),{preference:o}=F(),v=n.useCallback(()=>{m.current&&(clearInterval(m.current),m.current=null);const f=y.current;if(f.length===0)return;const c=f[Math.floor(Math.random()*f.length)].index;a(c),h(c),w.current(S.current[c])},[]),{playDrumroll:I,stopDrumroll:j}=X({onDrumrollEnd:v,enabled:o.volume>0,volume:o.volume});n.useEffect(()=>{S.current=r},[r]),n.useEffect(()=>{w.current=d},[d]),n.useEffect(()=>{if(!e||r.length===0){j();return}const c=r.slice(0,25).map((g,N)=>({prize:g,index:N})).filter(({prize:g})=>!g.selected);if(y.current=c,c.length===0){j();return}return a(c[0].index),h(null),I(),m.current=setInterval(()=>{a(g=>{if(c.length===1)return c[0].index;let N=c[Math.floor(Math.random()*c.length)].index;return N===g&&(N=c[(Math.floor(Math.random()*(c.length-1))+1)%c.length].index),N})},120),()=>{m.current&&(clearInterval(m.current),m.current=null),j()}},[e,I,r,j]);const E=r.slice(0,25);return t.jsx(T,{open:e,onClose:s,title:"景品ルーレット",titleClassName:"text-xl",contentClassName:"w-2xl",children:t.jsx("div",{className:"mt-6 grid grid-cols-5 gap-1.25",children:E.map((f,c)=>{const g=c===l,N=c===b,i=f.selected;return t.jsx("div",{className:"aspect-square",children:t.jsx("div",{className:k("roulette-card flex h-full w-full items-center justify-center text-3xl",i&&"roulette-card--disabled",g&&!i&&"roulette-card--active",N&&!i&&"roulette-card--winner"),children:f.prizeName||"賞名未設定"})},f.id)})})})},je=({className:e=""})=>{const{prizes:r,isLoading:s,isMutating:d,error:l,togglePrize:a}=te(),[b,h]=n.useState(!1),[m,y]=n.useState(!1),[S,w]=n.useState(null),[o,v]=n.useState(!0),[I,j]=n.useState(new Set),E=n.useMemo(()=>{const i=r.filter(p=>p.selected).length;return{total:r.length,selected:i,remaining:r.length-i}},[r]);n.useEffect(()=>{j(i=>{const p=new Set(r.map(R=>R.id)),x=new Set;if(!o){for(const R of p)x.add(R);return x}for(const R of i)p.has(R)&&x.add(R);return x})},[r,o]);const f=i=>{j(p=>{const x=new Set(p);return x.has(i)?x.delete(i):x.add(i),x})},c=()=>{v(i=>{const p=!i;return j(p?new Set:new Set(r.map(x=>x.id))),p})},g=()=>{y(!1),h(!0)},N=async i=>{if(h(!1),!i.selected)try{await a(i.id,!0)}catch{}w(i),y(!0)};return t.jsxs("section",{className:`flex h-full flex-col rounded-3xl border border-border bg-card p-4 text-foreground ${e}`,children:[t.jsxs("header",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-5",children:[t.jsx("h2",{className:"text-base",children:"景品一覧"}),t.jsxs("span",{className:"text-muted-foreground text-xs",children:["当選済み ",E.selected," / ",E.total]})]}),t.jsx(C,{type:"button",variant:"secondary",className:"rounded-full border border-border px-3 py-1 text-xs hover:bg-muted disabled:opacity-50",onClick:c,disabled:s,children:o?"賞名表示":"賞品表示"})]}),t.jsx("div",{className:"no-scrollbar mt-4 flex h-full w-full flex-1 items-center justify-center overflow-y-auto pr-1",children:s?t.jsx("p",{className:"text-muted-foreground text-sm",children:"景品情報を読み込み中..."}):t.jsx(Ne,{prizes:r,disabled:d,onToggle:a,itemNameOverrides:I,onToggleDisplay:f})}),t.jsx(C,{type:"button",className:"mt-4 w-full rounded-full bg-primary px-6 py-2 text-primary-foreground text-sm shadow-sm hover:bg-primary disabled:opacity-40",onClick:g,disabled:s||r.length===0,children:"景品ルーレット"}),l&&t.jsx("p",{className:"mt-3 text-destructive text-xs",children:l}),t.jsx(ve,{open:b,prizes:r,onClose:()=>h(!1),onComplete:N}),t.jsx(we,{open:m,prize:S,onClose:()=>y(!1)})]})},Re=()=>{const{session:e,isLoading:r,isMutating:s,isResetting:d,loadError:l,drawError:a,resetOpen:b,displayNumber:h,isAnimating:m,availableNumbers:y,isButtonDisabled:S,drawButtonLabel:w,openResetDialog:o,closeResetDialog:v,startDrawAnimation:I,completeDrawAnimation:j,handleReset:E,handleBackToStart:f}=he(),{preference:c,isReady:g,setVolume:N}=F({defaultVolume:.4}),{playDrumroll:i}=X({onDrumrollEnd:j,enabled:c.volume>0,volume:c.volume}),p=n.useRef(null),x=n.useRef(!1),R=n.useRef(!1),B=n.useRef(!1),P=n.useCallback(()=>{const u=p.current;u&&(u.play(),x.current=!0)},[]),O=n.useCallback(()=>{R.current&&(R.current=!1,B.current=!1,P())},[P]),L=n.useCallback(()=>{if(B.current)return;B.current=!0;const u=()=>O();document.addEventListener("pointerdown",u,{once:!0}),document.addEventListener("keydown",u,{once:!0})},[O]);n.useEffect(()=>{const u=new G.Howl({src:["/game-bgm.mp3"],loop:!0,preload:!0,onplayerror:()=>{R.current=!0,x.current=!1,L()}});return p.current=u,()=>{u.stop(),u.unload(),p.current=null}},[L]),n.useEffect(()=>{const u=p.current;if(u){if(u.volume(c.volume*.2),c.volume>0){x.current||P();return}x.current&&(u.stop(),x.current=!1)}},[c.volume,P]);const _=()=>{S||(I(),i())};return r?t.jsx("main",{className:"flex min-h-screen items-center justify-center bg-background text-foreground",children:t.jsx("p",{className:"text-muted-foreground text-sm",children:"読み込み中..."})}):l||!e?t.jsxs("main",{className:"flex min-h-screen flex-col items-center justify-center gap-4 bg-background text-foreground",children:[t.jsx("p",{className:"text-destructive text-sm",children:"データの読み込みに失敗しました。"}),t.jsx(C,{type:"button",className:"rounded border border-border px-4 py-2 text-muted-foreground text-sm hover:bg-muted",onClick:f,children:"Start 画面に戻る"})]}):t.jsxs(re,{initialPrizes:e.prizes,children:[t.jsx("main",{className:"h-screen overflow-hidden bg-background text-foreground",children:t.jsxs("div",{className:"flex h-full w-full flex-col border border-border bg-card shadow-[0_4px_20px_hsl(var(--foreground)/0.08)]",children:[t.jsxs("header",{className:"flex items-center justify-between px-6 py-4",children:[t.jsx(C,{type:"button",variant:"secondary",className:k("rounded-full border border-border px-3 py-1 text-sm hover:bg-muted","relative top-2"),onClick:o,disabled:r||d||e.historyView.length===0,children:"クリア"}),t.jsxs("div",{className:"relative flex items-center gap-3",children:[t.jsx(le,{preference:c,isReady:g,onVolumeChange:N,showSoundSlider:!1}),t.jsx(C,{type:"button",variant:"secondary",className:"rounded-full!","aria-label":"Start 画面に戻る",onClick:f,children:t.jsx(z,{className:"aspect-square h-6 w-6"})})]})]}),t.jsxs("div",{className:"flex flex-1 gap-6 overflow-hidden px-6 pb-6",children:[t.jsx(be,{recent:e.historyView,className:"flex-[0_0_420px]"}),t.jsxs("section",{className:"flex flex-1 flex-col items-center justify-center gap-8",children:[t.jsx(ge,{value:h,isDrawing:m||s}),t.jsxs(C,{type:"button",className:"flex w-80 items-center justify-center gap-2 rounded-full bg-primary px-8 py-4 text-primary-foreground text-xl shadow-sm hover:bg-primary",onClick:_,disabled:S,children:[(m||s)&&t.jsx(oe,{className:"animate-spin"}),w]}),a==="no-available-numbers"&&t.jsx("p",{className:"text-destructive text-sm",children:"すべての番号が抽選済みです。"}),t.jsxs("p",{className:"text-muted-foreground text-xs",children:["残り ",y.length," / 75"]})]}),t.jsx(je,{className:"flex-[0_0_420px]"})]})]})}),t.jsx(pe,{open:b,onClose:v,onConfirm:E,disabled:d})]})},Ie=Y(function(){return t.jsx(ee,{enabled:!1,children:t.jsx(Re,{})})});export{Ie as default};
