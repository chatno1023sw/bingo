import{c as N,r as O,s as I,w as $}from"./CommonDialog-EJvDp-ao.js";import{r as a,j as q}from"./chunk-JMJ3UQ3L-CakUOnqu.js";const B=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],Q=N("image",B),J="bingo-prize-images",u="prize-images",x="idb:",w=()=>typeof globalThis<"u"&&typeof globalThis.indexedDB<"u",K=()=>w()?new Promise((e,t)=>{const r=indexedDB.open(J,1);r.onupgradeneeded=()=>{const s=r.result;s.objectStoreNames.contains(u)||s.createObjectStore(u)},r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error??new Error("indexeddb-open-error"))}):Promise.reject(new Error("indexeddb-unavailable")),E=async e=>{const t=await K();try{return await e(t)}finally{t.close()}},V=e=>`${x}${e}`,y=e=>typeof e=="string"&&e.startsWith(x),z=e=>e.slice(x.length),X=async(e,t)=>{if(!w())throw new Error("indexeddb-unavailable");await E(r=>new Promise((s,o)=>{const n=r.transaction(u,"readwrite");n.oncomplete=()=>s(),n.onerror=()=>o(n.error??new Error("image-storage-write-error")),n.onabort=()=>o(n.error??new Error("image-storage-write-error")),n.objectStore(u).put(t,e)}))},T=async e=>w()?E(t=>new Promise((r,s)=>{const i=t.transaction(u,"readonly").objectStore(u).get(e);i.onsuccess=()=>r(i.result??null),i.onerror=()=>s(i.error??new Error("image-storage-read-error"))})):null,_=async e=>{w()&&await E(t=>new Promise((r,s)=>{const o=t.transaction(u,"readwrite");o.oncomplete=()=>r(),o.onerror=()=>s(o.error??new Error("image-storage-delete-error")),o.onabort=()=>s(o.error??new Error("image-storage-delete-error")),o.objectStore(u).delete(e)}))},A=async e=>{!w()||e.length===0||await Promise.all(e.map(t=>_(t)))},j=()=>O(I.prizes,[]),k=e=>[...e].sort((t,r)=>t.order-r.order).map((t,r)=>({...t,order:r})),R=e=>{const t=k(e);return $(I.prizes,t),t},h=async()=>k(j()),W=async(e,t)=>{const s=(await h()).map(o=>o.id===e?{...o,selected:t}:o);return R(s)},F=async e=>{const r=j().map(n=>n.imagePath).filter(y).map(n=>z(n)),s=new Set(e.map(n=>n.imagePath).filter(y).map(n=>z(n))),o=r.filter(n=>!s.has(n));await A(o),R(e)},b=e=>e?[...e].sort((t,r)=>t.order-r.order):[],P=e=>e instanceof Error?e.message:"unknown-error",U=a.createContext(void 0),Y=({initialPrizes:e,children:t})=>{const[r,s]=a.useState(()=>b(e)),[o,n]=a.useState(!e),[i,d]=a.useState(!1),[v,f]=a.useState(null),m=a.useCallback(async()=>{n(!0);try{const c=await h();s(c),f(null)}catch(c){const l=P(c);throw f(l),c}finally{n(!1)}},[]);a.useEffect(()=>{if(e){s(b(e)),n(!1);return}m().catch(()=>{})},[e,m]),a.useEffect(()=>{if(typeof window>"u")return()=>{};const c=l=>{l.key===I.prizes&&m().catch(()=>{})};return window.addEventListener("storage",c),()=>window.removeEventListener("storage",c)},[m]);const S=a.useCallback(async(c,l)=>{d(!0);try{const g=r.find(D=>D.id===c),p=typeof l=="boolean"?l:g?!g.selected:!0,M=await W(c,p);s(M),f(null)}catch(g){const p=P(g);throw f(p),g}finally{d(!1)}},[r]),L=a.useCallback(async c=>{d(!0),s(b(c));try{await F(c);const l=await h();s(l),f(null)}catch(l){const g=P(l);throw f(g),l}finally{d(!1)}},[]),C=a.useMemo(()=>({prizes:r,isLoading:o,isMutating:i,error:v,refresh:m,togglePrize:S,applyPrizes:L}),[r,o,i,v,m,S,L]);return q.jsx(U.Provider,{value:C,children:t})},Z=()=>{const e=a.useContext(U);if(!e)throw new Error("usePrizeManager must be used within PrizeProvider");return e},ee=e=>{const[t,r]=a.useState(()=>e?y(e)?null:e:null),s=a.useRef(null);return a.useEffect(()=>{let o=!1;if(s.current&&(URL.revokeObjectURL(s.current),s.current=null),!e)return r(null),()=>{};if(!y(e))return r(e),()=>{};r(null);const n=z(e);return T(n).then(i=>{if(o)return;if(!i){r(null);return}const d=URL.createObjectURL(i);s.current=d,r(d)}).catch(()=>{o||r(null)}),()=>{o=!0,s.current&&(URL.revokeObjectURL(s.current),s.current=null)}},[e]),t};export{Q as I,Y as P,Z as a,V as b,_ as d,X as s,ee as u};
