import{r as n,u as Q,j as t,w as Y}from"./chunk-JMJ3UQ3L-CakUOnqu.js";import{c as Z,j as T,i as M,C as U,B as k,s as z,X as ee,S as te}from"./CommonDialog-Dfx684_S.js";import{u as W,I as F,a as re,P as ne}from"./useStoredImage-DYulu_jT.js";import{p as G,r as se,s as le,u as H,B as ae}from"./BgmControl-Ch9JafY7.js";const oe=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],ce=Z("loader-circle",oe),K=(e={})=>{const l=n.useRef(null),a=n.useRef(null),h=n.useRef(null),d=n.useRef(()=>{}),f=n.useRef(null),g=n.useRef(5e3),w=n.useRef(!0),N=n.useRef(1),R=n.useRef(!1);n.useEffect(()=>{h.current=e.onDrumrollEnd??null},[e.onDrumrollEnd]),n.useEffect(()=>{g.current=e.fallbackWaitMs??5e3},[e.fallbackWaitMs]);const v=n.useCallback(()=>{const b=(w.current?N.current:0)*.9,u=Math.min(1,Math.max(b*1.5,.4));l.current&&l.current.volume(u),a.current&&a.current.volume(u)},[]),p=n.useCallback(()=>{f.current&&(clearTimeout(f.current),f.current=null)},[]),S=n.useCallback(()=>{p(),!(g.current<=0)&&(f.current=setTimeout(()=>{f.current=null,d.current()},g.current))},[p]);n.useEffect(()=>{w.current=e.enabled??!0,v()},[v,e.enabled]),n.useEffect(()=>{N.current=e.volume??1,v()},[v,e.volume]);const E=n.useCallback(()=>{const o=a.current;o&&(!w.current||N.current<=0||(o.stop(),o.seek(0),o.play()))},[]);n.useEffect(()=>{d.current=()=>{R.current&&(R.current=!1,p(),h.current?.(),E())}},[p,E]),n.useEffect(()=>{const o=new T.Howl({src:["./drumroll.mp3"],preload:!0,onend:()=>d.current(),onloaderror:()=>{g.current<=0&&d.current()},onplayerror:()=>{g.current<=0&&d.current()}}),b=new T.Howl({src:["./cymbal.mp3"],preload:!0});return l.current=o,a.current=b,v(),()=>{p(),o.unload(),b.unload(),l.current=null,a.current=null}},[v,p]);const x=n.useCallback(()=>{const o=l.current;o&&(R.current=!0,S(),!(!w.current||N.current<=0)&&(o.stop(),o.seek(0),o.play()))},[S]),i=n.useCallback(()=>{const o=l.current;o&&(R.current=!1,p(),o.stop())},[p]);return{playDrumroll:x,stopDrumroll:i,playCymbal:E}},ue=e=>[...e.drawHistory].sort((r,s)=>s.sequence-r.sequence),X=1,ie=75,de=ie-X+1;class q extends Error{constructor(){super("no-available-numbers"),this.name="NoAvailableNumbersError"}}const me=()=>Array.from({length:de},(e,r)=>X+r),J=e=>{const r=new Set(e.map(s=>s.number));return me().filter(s=>!r.has(s))},fe=(e,r)=>{if(e.length===0)throw new q;if(typeof r=="number"&&Number.isFinite(r)){const l=Math.abs(Math.trunc(r))%e.length;return e[l]}const s=Math.min(e.length-1,Math.floor(Math.random()*e.length));return e[s]},xe=(e,r={})=>{const s=J(e.drawHistory);if(s.length===0)throw new q;const c=r.timestamp??new Date().toISOString(),l=fe(s,r.seed),a={number:l,sequence:e.drawHistory.length+1,drawnAt:c};return{...e,currentNumber:l,drawHistory:[...e.drawHistory,a],isDrawing:!1,updatedAt:c}},he=Array.from({length:75},(e,r)=>r+1),$=async()=>{const e=await se();return e||le()},V=async e=>{const r=ue(e.gameState),s=J(e.gameState.drawHistory);return{...e,historyView:r,availableNumbers:s}},ge=()=>{const[e,r]=n.useState(null),[s,c]=n.useState(!0),[l,a]=n.useState(!1),[h,d]=n.useState(!1),[f,g]=n.useState(null),[w,N]=n.useState(null),[R,v]=n.useState(!1),p=Q(),[S,E]=n.useState(null),[x,i]=n.useState(!1),o=n.useRef(null),b=n.useRef(!1),u=e?.availableNumbers??[],C=l||h||x||u.length===0,j=e?.gameState.currentNumber??null;n.useEffect(()=>{let y=!0;return(async()=>{try{const m=await $(),L=await V(m);if(!y)return;r(L),g(null)}catch(m){if(!y)return;g(m instanceof Error?m.message:"load-session-error")}finally{y&&c(!1)}})(),()=>{y=!1}},[]),n.useEffect(()=>{x||E(j)},[x,j]),n.useEffect(()=>()=>{o.current&&clearInterval(o.current)},[]);const D=async()=>{a(!0);try{const y=e??await $(),I=xe(y.gameState),m={...y,gameState:I};await G(m);const L=await V(m);r(L),N(null)}catch(y){if(y instanceof q){N("no-available-numbers");return}N("draw-error")}finally{a(!1)}},_=async()=>{if(e){d(!0);try{const y=new Date().toISOString(),I={...e.gameState,currentNumber:null,drawHistory:[],isDrawing:!1,updatedAt:y},m={...e,gameState:I};await G(m);const L=await V(m);r(L),N(null),v(!1)}finally{d(!1)}}},P=()=>{if(x||l||h||u.length===0)return;const y=u.length>0?u:he;i(!0),b.current=!0,o.current=setInterval(()=>{const I=y[Math.floor(Math.random()*y.length)];E(I)},120)},O=()=>{b.current&&(b.current=!1,o.current&&(clearInterval(o.current),o.current=null),i(!1),D())},A=()=>{p("/start")},B=u.length===0?"抽選は完了しました":x||l?"抽選中":"抽選を開始！";return{session:e,isLoading:s,isMutating:l,isResetting:h,loadError:f,drawError:w,resetOpen:R,displayNumber:S,isAnimating:x,availableNumbers:u,isButtonDisabled:C,drawButtonLabel:B,openResetDialog:()=>v(!0),closeResetDialog:()=>v(!1),startDrawAnimation:P,completeDrawAnimation:O,handleReset:_,handleBackToStart:A}},be=({value:e,isDrawing:r})=>{const s=e==null?"--":e.toString();return t.jsx("div",{className:"flex flex-col items-center gap-6 text-foreground",children:t.jsx("div",{className:M("flex h-112 w-md items-center justify-center rounded border border-border bg-card font-bold text-[15rem] transition",r?"opacity-50":"opacity-100"),children:s})})},pe=e=>{const r=e.length;if(r===0)return[];const s=r%4,c=Math.floor(r/4),l=s===0?0:1,a=s===0?4:s,h=[e.slice(0,a)];for(let d=a;d<r;d+=4)h.push(e.slice(d,d+4));return h.map((d,f)=>{const g=f-l,w=r<4?0:g>=0?(c-g)*4:(c+1)*4;return{entries:d,labelCount:w}})},ye=({recent:e,className:r=""})=>{const s=pe(e);return t.jsx("section",{className:M("flex h-full flex-col rounded-3xl border border-border bg-card p-4 text-foreground",r),children:t.jsx("div",{className:M("no-scrollbar flex-1 overflow-y-auto pr-2",e.length===0?"flex h-full w-full items-center justify-center":""),children:e.length===0?t.jsx("div",{className:"text-muted-foreground text-sm",children:"まだ抽選結果されてないよ"}):t.jsx("div",{className:"flex flex-col gap-3",children:s.map((c,l)=>{const a=c.entries[0]?.sequence??`row-${l}`;return t.jsxs("div",{className:"flex flex-col gap-3",children:[c.labelCount>0?t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("span",{className:"text-muted-foreground text-xs",children:`${c.labelCount}`}),t.jsx("div",{className:"h-px w-full bg-border"})]}):null,t.jsx("div",{className:"grid grid-cols-4 gap-3",children:c.entries.map(h=>t.jsx("div",{className:"flex aspect-square min-h-24 items-center justify-center rounded border border-border text-[clamp(24px,5vw,84px)]",children:h.number},h.sequence))})]},`history-row-${a}`)})})})})},we=({open:e,title:r="抽選履歴を削除する？",description:s="あたらしく抽選を始めよう！",onClose:c,onConfirm:l,disabled:a=!1})=>t.jsx(U,{open:e,onClose:c,title:r,description:s,showCloseButton:!0,closeDisabled:a,footer:t.jsxs(t.Fragment,{children:[t.jsx(k,{type:"button",variant:"outline",className:"flex-1 rounded-2xl border border-border px-4 py-3 text-muted-foreground hover:bg-muted",onClick:c,disabled:a,children:"キャンセル"}),t.jsx(k,{type:"button",className:"flex-1 rounded-2xl border border-transparent bg-destructive px-4 py-3 text-destructive-foreground hover:bg-destructive/90",onClick:l,disabled:a,children:"削除"})]})}),Ne=({prize:e,disabled:r=!1,onToggle:s,showPrizeNameOnly:c,onToggleDisplay:l})=>{const a=W(e.imagePath),h=!!a,d=()=>{s(e.id,!e.selected)};return t.jsxs("li",{className:M("flex w-full min-w-0 items-center gap-3 rounded-2xl border px-3 py-3 text-sm transition",e.selected?"border-border bg-muted opacity-70":"border-border bg-card"),children:[t.jsx("div",{className:"flex aspect-4/3 w-14 items-center justify-center overflow-hidden rounded-lg bg-muted",children:h?t.jsx("img",{src:a??"",alt:`${e.prizeName||"景品"} 画像`,className:"h-full w-full object-cover object-center"}):t.jsx(F,{className:"h-8 w-8 text-muted-foreground",strokeWidth:1.5,"aria-hidden":"true"})}),t.jsx("div",{className:"flex-1 min-w-0",children:t.jsx("button",{type:"button",className:M("line-clamp-2 w-full min-w-0 cursor-pointer break-all text-left text-3xl focus:outline-none",e.selected?"text-muted-foreground line-through":"text-foreground"),onClick:()=>l(e.id),disabled:r,children:c?e.prizeName:e.itemName})}),t.jsx(k,{type:"button",variant:(e.selected,"secondary"),className:M("rounded-full px-4 py-1 text-xs",e.selected&&"border border-border text-muted-foreground"),onClick:d,disabled:r,children:e.selected?"戻す":"除外"})]})},ve=({prizes:e,disabled:r=!1,onToggle:s,itemNameOverrides:c,onToggleDisplay:l})=>e.length===0?t.jsx("p",{className:"text-muted-foreground text-sm",children:"まだ景品が登録されてないよ"}):t.jsx("ul",{className:"h-full w-full min-w-0 space-y-3",children:e.map(a=>t.jsx(Ne,{prize:a,disabled:r,onToggle:s,showPrizeNameOnly:!c.has(a.id),onToggleDisplay:l},a.id))}),je=({open:e,prize:r,onClose:s})=>{const c=W(r?.imagePath??null),l=!!c;return r?t.jsx(U,{open:e,onClose:s,title:"おめでとうございます！",titleClassName:"pt-8 text-3xl",headerClassName:"text-center",contentClassName:"flex flex-col items-center justify-center",showCloseButton:!0,children:t.jsxs("div",{className:"flex flex-col items-center justify-center space-y-4",children:[t.jsx("div",{className:"flex h-48 w-full items-center justify-center rounded-2xl",children:l?t.jsx("img",{src:c??"",alt:`${r.prizeName||"景品"} 画像`,className:"h-full w-full rounded-2xl object-cover object-center"}):t.jsx(F,{className:"h-48 w-48 text-muted-foreground",strokeWidth:1.5,"aria-hidden":"true"})}),t.jsxs("div",{className:"flex w-full flex-col items-center justify-center space-y-2 text-3xl text-foreground",children:[t.jsx("p",{children:r.prizeName||"未設定"}),t.jsx("p",{children:r.itemName||"未設定"})]})]})}):null},Re=({open:e,prizes:r,onClose:s,onComplete:c})=>{const[l,a]=n.useState(0),[h,d]=n.useState(null),f=n.useRef(null),g=n.useRef([]),w=n.useRef([]),N=n.useRef(()=>{}),{preference:R}=H(),v=n.useCallback(()=>{f.current&&(clearInterval(f.current),f.current=null);const x=g.current;if(x.length===0)return;const i=x[Math.floor(Math.random()*x.length)].index;a(i),d(i),N.current(w.current[i])},[]),{playDrumroll:p,stopDrumroll:S}=K({onDrumrollEnd:v,enabled:R.volume>0,volume:R.volume});n.useEffect(()=>{w.current=r},[r]),n.useEffect(()=>{N.current=c},[c]),n.useEffect(()=>{if(!e||r.length===0){S();return}const i=r.slice(0,25).map((o,b)=>({prize:o,index:b})).filter(({prize:o})=>!o.selected);if(g.current=i,i.length===0){S();return}return a(i[0].index),d(null),p(),f.current=setInterval(()=>{a(o=>{if(i.length===1)return i[0].index;let b=i[Math.floor(Math.random()*i.length)].index;return b===o&&(b=i[(Math.floor(Math.random()*(i.length-1))+1)%i.length].index),b})},120),()=>{f.current&&(clearInterval(f.current),f.current=null),S()}},[e,p,r,S]);const E=r.slice(0,25);return t.jsx(U,{open:e,onClose:s,title:"景品ルーレット",titleClassName:"text-xl",contentClassName:"w-2xl",children:t.jsx("div",{className:"mt-6 grid grid-cols-5 gap-1.25",children:E.map((x,i)=>{const o=i===l,b=i===h,u=x.selected;return t.jsx("div",{className:"aspect-square",children:t.jsx("div",{className:M("roulette-card flex h-full w-full items-center justify-center text-3xl",u&&"roulette-card--disabled",o&&!u&&"roulette-card--active",b&&!u&&"roulette-card--winner"),children:x.prizeName||"賞名未設定"})},x.id)})})})},Se=({className:e=""})=>{const{prizes:r,isLoading:s,isMutating:c,error:l,togglePrize:a}=re(),[h,d]=n.useState(!1),[f,g]=n.useState(!1),[w,N]=n.useState(null),[R,v]=n.useState(!0),[p,S]=n.useState(new Set),E=n.useMemo(()=>{const u=r.filter(C=>C.selected).length;return{total:r.length,selected:u,remaining:r.length-u}},[r]);n.useEffect(()=>{S(u=>{const C=new Set(r.map(D=>D.id)),j=new Set;if(!R){for(const D of C)j.add(D);return j}for(const D of u)C.has(D)&&j.add(D);return j})},[r,R]);const x=u=>{S(C=>{const j=new Set(C);return j.has(u)?j.delete(u):j.add(u),j})},i=()=>{v(u=>{const C=!u;return S(C?new Set:new Set(r.map(j=>j.id))),C})},o=()=>{g(!1),d(!0)},b=async u=>{if(d(!1),!u.selected)try{await a(u.id,!0)}catch{}N(u),g(!0)};return t.jsxs("section",{className:`flex h-full w-full min-w-0 flex-col rounded-3xl border border-border bg-card p-4 text-foreground ${e}`,children:[t.jsxs("header",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-5",children:[t.jsx("h2",{className:"text-base",children:"景品一覧"}),t.jsxs("span",{className:"text-muted-foreground text-xs",children:["当選済み ",E.selected," / ",E.total]})]}),t.jsx(k,{type:"button",variant:"secondary",className:"rounded-full border border-border px-3 py-1 text-xs hover:bg-muted disabled:opacity-50",onClick:i,disabled:s,children:R?"賞名表示":"賞品表示"})]}),t.jsx("div",{className:"no-scrollbar mt-4 flex h-full w-full min-w-0 flex-1 items-center justify-center overflow-y-auto pr-1",children:s?t.jsx("p",{className:"text-muted-foreground text-sm",children:"景品情報を読み込み中..."}):t.jsx(ve,{prizes:r,disabled:c,onToggle:a,itemNameOverrides:p,onToggleDisplay:x})}),t.jsx(k,{type:"button",className:"mt-4 w-full rounded-full bg-primary px-6 py-2 text-primary-foreground text-sm shadow-sm hover:bg-primary disabled:opacity-40",onClick:o,disabled:s||r.length===0,children:"景品ルーレット"}),l&&t.jsx("p",{className:"mt-3 text-destructive text-xs",children:l}),t.jsx(Re,{open:h,prizes:r,onClose:()=>d(!1),onComplete:b}),t.jsx(je,{open:f,prize:w,onClose:()=>g(!1)})]})},Ee=()=>{const{session:e,isLoading:r,isMutating:s,isResetting:c,loadError:l,drawError:a,resetOpen:h,displayNumber:d,isAnimating:f,availableNumbers:g,isButtonDisabled:w,drawButtonLabel:N,openResetDialog:R,closeResetDialog:v,startDrawAnimation:p,completeDrawAnimation:S,handleReset:E,handleBackToStart:x}=ge(),{preference:i,isReady:o,setVolume:b}=H({defaultVolume:.1}),{preference:u,setVolume:C}=H({storageKey:z.se,defaultVolume:.2}),{playDrumroll:j}=K({onDrumrollEnd:S,enabled:u.volume>0,volume:u.volume}),D=n.useRef(null),_=n.useRef(!1),P=n.useRef(!1),O=n.useRef(!1),A=n.useCallback(()=>{const m=D.current;m&&(m.play(),_.current=!0)},[]),B=n.useCallback(()=>{P.current&&(P.current=!1,O.current=!1,A())},[A]),y=n.useCallback(()=>{if(O.current)return;O.current=!0;const m=()=>B();document.addEventListener("pointerdown",m,{once:!0}),document.addEventListener("keydown",m,{once:!0})},[B]);n.useEffect(()=>{const m=new T.Howl({src:["./game-bgm.mp3"],loop:!0,preload:!0,onplayerror:()=>{P.current=!0,_.current=!1,y()}});return D.current=m,()=>{m.stop(),m.unload(),D.current=null}},[y]),n.useEffect(()=>{const m=D.current;if(m){if(m.volume(i.volume*.2),i.volume>0){_.current||A();return}_.current&&(m.stop(),_.current=!1)}},[i.volume,A]);const I=()=>{w||(p(),j())};return r?t.jsx("main",{className:"flex min-h-screen items-center justify-center bg-background text-foreground",children:t.jsx("p",{className:"text-muted-foreground text-sm",children:"読み込み中..."})}):l||!e?t.jsxs("main",{className:"flex min-h-screen flex-col items-center justify-center gap-4 bg-background text-foreground",children:[t.jsx("p",{className:"text-destructive text-sm",children:"データの読み込みに失敗しました。"}),t.jsx(k,{type:"button",className:"rounded border border-border px-4 py-2 text-muted-foreground text-sm hover:bg-muted",onClick:x,children:"Start 画面に戻る"})]}):t.jsxs(ne,{initialPrizes:e.prizes,children:[t.jsx("main",{className:"h-screen overflow-hidden bg-background text-foreground",children:t.jsxs("div",{className:"flex h-full w-full flex-col border border-border bg-card shadow-[0_4px_20px_hsl(var(--foreground)/0.08)]",children:[t.jsxs("header",{className:"flex items-center justify-between px-6 py-4",children:[t.jsx(k,{type:"button",variant:"secondary",className:M("rounded-full border border-border px-3 py-1 text-sm hover:bg-muted","relative top-2"),onClick:R,disabled:r||c||e.historyView.length===0,children:"クリア"}),t.jsxs("div",{className:"relative flex items-center gap-3",children:[t.jsx(ae,{preference:i,soundPreference:u,isReady:o,onVolumeChange:b,onSoundVolumeChange:C}),t.jsx(k,{type:"button",variant:"secondary",className:"rounded-full!","aria-label":"Start 画面に戻る",onClick:x,children:t.jsx(ee,{className:"aspect-square h-6 w-6"})})]})]}),t.jsxs("div",{className:"flex flex-1 gap-6 overflow-hidden px-6 pb-6",children:[t.jsx(ye,{recent:e.historyView,className:"flex-[0_0_30vw]"}),t.jsxs("section",{className:"flex flex-1 flex-col items-center justify-center gap-8",children:[t.jsx(be,{value:d,isDrawing:f||s}),t.jsxs(k,{type:"button",className:"flex w-80 items-center justify-center gap-2 rounded-full bg-primary px-8 py-4 text-primary-foreground text-xl shadow-sm hover:bg-primary",onClick:I,disabled:w,children:[(f||s)&&t.jsx(ce,{className:"animate-spin"}),N]}),a==="no-available-numbers"&&t.jsx("p",{className:"text-destructive text-sm",children:"すべての番号が抽選済みです。"}),t.jsxs("p",{className:"text-muted-foreground text-xs",children:["残り ",g.length," / 75"]})]}),t.jsx(Se,{className:"flex-[0_0_30vw]"})]})]})}),t.jsx(we,{open:h,onClose:v,onConfirm:E,disabled:c})]})},Me=Y(function(){return t.jsx(te,{enabled:!0,children:t.jsx(Ee,{})})});export{Me as default};
